<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<title data-react-helmet="true">Custom Template | Substrate Playground</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Custom Template | Substrate Playground"><meta data-react-helmet="true" name="description" content="External users can provide and maintain templates used by the playground."><meta data-react-helmet="true" property="og:description" content="External users can provide and maintain templates used by the playground."><meta data-react-helmet="true" property="og:url" content="https://playground.substrate.dev/substrate-playground/docs/extending/custom-template"><link data-react-helmet="true" rel="shortcut icon" href="/substrate-playground/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://playground.substrate.dev/substrate-playground/docs/extending/custom-template"><link rel="stylesheet" href="/substrate-playground/styles.8ef1dbc3.css">
<link rel="preload" href="/substrate-playground/styles.059e9a4c.js" as="script">
<link rel="preload" href="/substrate-playground/runtime~main.80a0515a.js" as="script">
<link rel="preload" href="/substrate-playground/main.8e569e49.js" as="script">
<link rel="preload" href="/substrate-playground/1.4fd03137.js" as="script">
<link rel="preload" href="/substrate-playground/17.6186122f.js" as="script">
<link rel="preload" href="/substrate-playground/18.337c2d49.js" as="script">
<link rel="preload" href="/substrate-playground/935f2afb.e741a4ac.js" as="script">
<link rel="preload" href="/substrate-playground/16.448a7119.js" as="script">
<link rel="preload" href="/substrate-playground/dc4f151a.87cafad8.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/substrate-playground/"><img src="/substrate-playground/img/favicon.png" alt="Parity Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Parity Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Playground</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/substrate-playground/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/paritytech/substrate-playground" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/substrate-playground/"><img src="/substrate-playground/img/favicon.png" alt="Parity Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Parity Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Playground</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/substrate-playground/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/paritytech/substrate-playground" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Using</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/substrate-playground/docs/">Overview</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Extending</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/substrate-playground/docs/extending/custom-template">Custom Template</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/substrate-playground/docs/extending/integration">Integration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Building</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/substrate-playground/docs/building/architecture">Architecture</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/substrate-playground/docs/building/build">Build</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/substrate-playground/docs/building/cicd">CI/CD</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Operating</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/substrate-playground/docs/operating/deployment">Deployment</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Custom Template</h1></header><div class="markdown"><p>External users can provide and maintain templates used by the playground.</p><p>To create a template the following steps are mandatory:</p><ul><li>create <code>.devcontainer/devcontainer.json</code> (find an example <a href="https://github.com/paritytech/substrate-playground/blob/develop/.github/workflow-templates/devcontainer.json" target="_blank" rel="noopener noreferrer">here</a>)</li><li>create a Github worflow that build this image then dispatches an event to <code>substrate-playground</code> (find an example <a href="https://github.com/paritytech/substrate-playground/blob/develop/.github/workflow-templates/cd-template.yml" target="_blank" rel="noopener noreferrer">here</a>)</li></ul><p>Additionally there are a number of standard VSCode configuration files that will be leveraged by the playground:</p><ul><li>.vscode/settings.json (see <a href="https://code.visualstudio.com/docs/getstarted/settings" target="_blank" rel="noopener noreferrer">https://code.visualstudio.com/docs/getstarted/settings</a>)</li><li>.vscode/launch.json</li><li>.vscode/tasks.json</li><li>.vscode/snippets.code-snippets</li></ul><p>After the associated Github <a href="https://github.com/paritytech/substrate-playground/blob/develop/.github/workflows/event-template-updated.yml" target="_blank" rel="noopener noreferrer">workflow</a> in substrate-playground is triggered, playground will use the newly built image. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="custom-commands"></a>Custom commands<a aria-hidden="true" class="hash-link" href="#custom-commands" title="Direct link to heading">#</a></h2><p>Replace ENV, USER, HOST (via ${containerEnv:VAR_NAME})</p><p><code>preCreateCommand</code> is executed </p><p><code>preContainerStartCommand</code> via Init Containers, can write files</p><p><code>postContainerStartCommand</code> via Container lifecycle hooks, run inside the container</p><p><code>preContainerStopCommand</code> via Container lifecycle hooks, run inside the container</p><p>Container killed after <code>terminationGracePeriodSeconds</code></p><p><a href="https://www.linkedin.com/pulse/kubernetes-deep-dive-part-1-init-containers-lifecycle-chauthaiwale/" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/pulse/kubernetes-deep-dive-part-1-init-containers-lifecycle-chauthaiwale/</a></p><p><a href="https://kubernetes.io/fr/docs/concepts/containers/container-lifecycle-hooks/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/fr/docs/concepts/containers/container-lifecycle-hooks/</a></p><p><code>preStartCommand</code></p><p><code>postStartCommand</code> (or <code>postAttachCommand</code>) are executed </p><p><code>menuActions</code> </p><p>TODO: support string and array syntax
TODO: add postCreateCommand</p><p>Potential hooks:</p><ul><li>when image is created (<code>preCreateCommand</code>)</li><li>when user deploy a template
<strong> server side
</strong> before theia loads
** after theia is loaded, headless or in a shell</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="github-workflow"></a>Github workflow<a aria-hidden="true" class="hash-link" href="#github-workflow" title="Direct link to heading">#</a></h2><p>A template workflow can be found <a href="https://github.com/paritytech/substrate-playground/blob/develop/.github/workflow-templates/cd-template.yml" target="_blank" rel="noopener noreferrer">here</a>.</p><p><code>client_payload</code> must define <code>id</code> pointing to one of the existing <a href="https://github.com/paritytech/substrate-playground/blob/develop/conf/k8s/overlays/staging/" target="_blank" rel="noopener noreferrer">templates</a>.
It can also define a <code>ref</code> (branch/tag/commit used to build, defaults to <em>master</em>) and a <code>dockerFile</code> location (default to <em>.devcontainer/Dockerfile</em>)</p><p>This workflow will trigger the <a href="https://github.com/paritytech/substrate-playground/blob/develop/.github/workflows/event-template-updated.yml" target="_blank" rel="noopener noreferrer"><em>template-updated</em> workflow</a> on <a href="https://github.com/paritytech/substrate-playground/" target="_blank" rel="noopener noreferrer">substrate-playground</a>, including the following actions:</p><ul><li>create and publish a <a href="https://github.com/paritytech/substrate-playground/blob/develop/templates/Dockerfile.template" target="_blank" rel="noopener noreferrer">composite docker image</a> from the new template one and latest <a href="https://github.com/paritytech/substrate-playground/blob/develop/templates/Dockerfile.base" target="_blank" rel="noopener noreferrer">base one</a></li><li>update <a href="https://github.com/paritytech/substrate-playground/tree/develop/conf/k8s/overlays/staging/templates" target="_blank" rel="noopener noreferrer">template image id</a></li><li>commit changes</li></ul><p>Changes to the configuration file are finally <a href="https://github.com/paritytech/substrate-playground/blob/develop/.github/workflows/cd-templates.yml" target="_blank" rel="noopener noreferrer">continuously deployed</a> to the staging playground environment as kubernetes ConfigMap.</p><p>Once live, images are tested and rollbacked if errors are detected.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-mermaid codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">sequenceDiagram</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CUSTOM_TEMPLATE-&gt;&gt;PLAYGROUND: Trigger template-updated</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    PLAYGROUND-&gt;&gt;PLAYGROUND: Build docker image</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    PLAYGROUND--&gt;&gt;PLAYGROUND: Build template docker image</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    PLAYGROUND--&gt;&gt;PLAYGROUND: Push new configuration to staging</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    PLAYGROUND--&gt;&gt;PLAYGROUND: Test new image</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="github-secrets"></a>Github secrets<a aria-hidden="true" class="hash-link" href="#github-secrets" title="Direct link to heading">#</a></h3><p>The following secrets must be defined:</p><p><code>REPO_ACCESS_TOKEN</code> a token with <code>public_repo</code> or repo scope</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deployment-workflow"></a>Deployment workflow<a aria-hidden="true" class="hash-link" href="#deployment-workflow" title="Direct link to heading">#</a></h2><p>A user creates a session by selecting a template. Extra arguments can be provided a deployment time (deployment specific: duration, .. or template specific: version)
The correct image name is retrieved, a Pod descriptor created (with conf as annotations), and associated Service (exporting the expected ports), and TODO a nginx Ingress exposing TCP (UPD?) ports, and a persistent workspace (or existing one, matched by template or repo). This workspace will receive a clone of the GIT repo, and a copy of pre-compiled repo if this is a template. Changes are kept arround. If USER has a matching repo fork, it will be configured accordingly. Git creds allows to push remote changes.
Based on user, add the right node metadata to select the right node.</p><p><a href="https://stackoverflow.com/questions/53683594/how-to-clone-a-private-git-repository-into-a-kubernetes-pod-using-ssh-keys-in-se" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/53683594/how-to-clone-a-private-git-repository-into-a-kubernetes-pod-using-ssh-keys-in-se</a></p><p>Configuration:</p><ul><li>global env (ConfigMap)</li><li>per template tag</li><li>per user tag</li></ul><p>All can be configured in Admin tab and have default values.</p><p>Allow to configure e.g. IDE, session duration, custom node pool, ..</p><p>TODO allow to github push with user
If a user fork is detected, offer to switch or add remote.
If not, offer to fork first.</p><ul><li>git remote add danforbes <a href="https://github.com/danforbes/substrate-node-template.git" target="_blank" rel="noopener noreferrer">https://github.com/danforbes/substrate-node-template.git</a></li><li>git fetch danforbes &amp;&amp; git checkout danforbes/master</li></ul><p>When a template is created:</p><ul><li>start a docker with theia</li><li>clone GH</li><li>run commands</li><li>persist VolumeClaim</li></ul><p>When a template is started</p><ul><li>locate the VolumeClaim, clone it (<a href="https://medium.com/@tyagi3192/persistent-volume-claim-cloning-in-kubernetes-9ea1101442a2" target="_blank" rel="noopener noreferrer">https://medium.com/@tyagi3192/persistent-volume-claim-cloning-in-kubernetes-9ea1101442a2</a>, <a href="https://kubernetes.io/blog/2019/06/21/introducing-volume-cloning-alpha-for-kubernetes/" target="_blank" rel="noopener noreferrer">https://kubernetes.io/blog/2019/06/21/introducing-volume-cloning-alpha-for-kubernetes/</a>)</li><li>start a container with the new VolumeClaim</li></ul><p>When a repo is started</p><ul><li>create a VolumeClaim with github clone</li><li>start a container with the new VolumeClaim</li></ul><p><a href="https://computingforgeeks.com/perform-git-clone-in-kubernetes-pod-deployment/" target="_blank" rel="noopener noreferrer">https://computingforgeeks.com/perform-git-clone-in-kubernetes-pod-deployment/</a>
<a href="https://gist.github.com/tallclair/849601a16cebeee581ef2be50c351841" target="_blank" rel="noopener noreferrer">https://gist.github.com/tallclair/849601a16cebeee581ef2be50c351841</a></p><p>TODO VolumeClaim and local usage? (CLI, devcontainer.json)
For CLI: copy local files, when done re-upload. Require starting an instance
kubectl cp POD-NAME:/data data/</p><ul><li><a href="https://github.com/kubernetes-client/javascript/blob/master/src/cp.ts" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-client/javascript/blob/master/src/cp.ts</a></li><li><a href="https://stackoverflow.com/questions/56761028/how-to-copy-files-between-pods-or-execute-in-a-pod" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/56761028/how-to-copy-files-between-pods-or-execute-in-a-pod</a></li><li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#cp" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#cp</a>
Or: mount fs via ssh</li><li><a href="https://linuxize.com/post/how-to-use-sshfs-to-mount-remote-directories-over-ssh/" target="_blank" rel="noopener noreferrer">https://linuxize.com/post/how-to-use-sshfs-to-mount-remote-directories-over-ssh/</a></li><li><a href="https://github.com/osxfuse/osxfuse/wiki/SSHFS" target="_blank" rel="noopener noreferrer">https://github.com/osxfuse/osxfuse/wiki/SSHFS</a></li><li><a href="https://www.expandrive.com/sshfs-mac/" target="_blank" rel="noopener noreferrer">https://www.expandrive.com/sshfs-mac/</a></li><li><a href="https://doc.ubuntu-fr.org/sshfs" target="_blank" rel="noopener noreferrer">https://doc.ubuntu-fr.org/sshfs</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-use-sshfs-to-mount-remote-file-systems-over-ssh" target="_blank" rel="noopener noreferrer">https://www.digitalocean.com/community/tutorials/how-to-use-sshfs-to-mount-remote-file-systems-over-ssh</a></li></ul><p>Keep a pod indefinitely: command: tail -f /dev/null</p><p>TODO security at theia level, grafana (only correct user can access)</p><p>Prevent concurrent usage from CLI, Remote in VSCode and web</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/// Share a single process namespace between all of the containers in a pod. When this is set containers will be able to view and signal processes from other containers in the same pod, and the first process in each container will not be assigned PID 1. HostPID and ShareProcessNamespace cannot both be set. Optional: Default to false. This field is beta-level and may be disabled with the PodShareProcessNamespace feature.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub share_process_namespace: Option&lt;bool&gt;,</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/paritytech/substrate-playground/edit/master/website/docs/extending/custom-template.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/substrate-playground/docs/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/substrate-playground/docs/extending/integration"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Integration Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#custom-commands" class="table-of-contents__link">Custom commands</a></li><li><a href="#github-workflow" class="table-of-contents__link">Github workflow</a><ul><li><a href="#github-secrets" class="table-of-contents__link">Github secrets</a></li></ul></li><li><a href="#deployment-workflow" class="table-of-contents__link">Deployment workflow</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://app.element.io/#/room/#watercooler:matrix.parity.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Element</a></li><li class="footer__item"><a href="https://twitter.com/ParityTech" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.parity.io/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://github.com/paritytech/substrate-playground" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2021 Parity, Inc.</div></div></div></footer></div>
<script src="/substrate-playground/styles.059e9a4c.js"></script>
<script src="/substrate-playground/runtime~main.80a0515a.js"></script>
<script src="/substrate-playground/main.8e569e49.js"></script>
<script src="/substrate-playground/1.4fd03137.js"></script>
<script src="/substrate-playground/17.6186122f.js"></script>
<script src="/substrate-playground/18.337c2d49.js"></script>
<script src="/substrate-playground/935f2afb.e741a4ac.js"></script>
<script src="/substrate-playground/16.448a7119.js"></script>
<script src="/substrate-playground/dc4f151a.87cafad8.js"></script>
</body>
</html>